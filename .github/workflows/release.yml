name: Release

on:
  workflow_dispatch: # Manual trigger

jobs:
  release-linux:
    name: Release Linux packages
    runs-on: ubuntu-latest
    container:
      image: electronuserland/builder
      env:
        TAR_OPTIONS: "--format=ustar"
        GH_TOKEN: ${{ secrets.GH_TOKEN }}

    steps:
      - uses: "actions/checkout@v4"

      - uses: "actions/setup-node@v4"
        with:
          node-version: '22.17.0'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm turbo run build --filter=@aider-desk/common --filter=@aider-desk/core --filter=@aider-desk/ui --filter=@aider-desk/mcp-server

      - name: Build and Release Linux
        working-directory: apps/electron
        run: pnpm run build && pnpm exec electron-builder --linux --x64 -p always
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Install GitHub CLI
        run: |
          apt-get update
          apt-get install -y --no-install-recommends gh ca-certificates

      - name: Mark repository as safe for git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Upload backwards compatible x64 AppImage (no x64 suffix)
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          APPIMAGE_ARCH=$(ls -1 apps/electron/dist/*.AppImage | grep -E -- '-(x64|x86_64)\.AppImage$' | head -n 1)
          if [ -z "$APPIMAGE_ARCH" ]; then
            echo "Could not find x64 AppImage in apps/electron/dist/" >&2
            ls -la apps/electron/dist
            exit 1
          fi

          APPIMAGE_COMPAT="$APPIMAGE_ARCH"
          APPIMAGE_COMPAT="${APPIMAGE_COMPAT%-x64.AppImage}"
          APPIMAGE_COMPAT="${APPIMAGE_COMPAT%-x86_64.AppImage}.AppImage"
          cp "$APPIMAGE_ARCH" "$APPIMAGE_COMPAT"

          echo "Created compat AppImage: $APPIMAGE_COMPAT"

          REPO="${GITHUB_REPOSITORY}"
          RELEASE_TAG=$(curl -fsSL \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/releases" \
            | node -e "let s='';process.stdin.on('data',d=>s+=d);process.stdin.on('end',()=>{const r=JSON.parse(s).find(x=>x.draft); if(!r){process.exit(1)}; console.log(r.tag_name)})")
          if [ -z "$RELEASE_TAG" ]; then
            echo "Could not find draft release tag" >&2
            exit 1
          fi

          gh release upload "$RELEASE_TAG" "$APPIMAGE_COMPAT" --clobber

      - name: Add compat AppImage entry to latest-linux.yml and upload to release
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Update latest-linux.yml with compat AppImage entry
          node - <<'NODE'
          const fs = require('fs');
          const yaml = require('js-yaml');

          const ymlPath = 'apps/electron/dist/latest-linux.yml';
          const data = yaml.load(fs.readFileSync(ymlPath, 'utf8'));

          const files = Array.isArray(data.files) ? data.files : [];
          const appImageIdx = files.findIndex((f) => typeof f?.url === 'string' && f.url.endsWith('.AppImage'));
          if (appImageIdx === -1) {
            throw new Error('Could not find AppImage entry in apps/electron/dist/latest-linux.yml');
          }

          const appImage = files[appImageIdx];
          const compatUrl = appImage.url.replace(/-(x64|x86_64)\.AppImage$/, '.AppImage');

          if (compatUrl === appImage.url) {
            throw new Error(`AppImage url did not match expected x64 suffix: ${appImage.url}`);
          }

          files.push({ ...appImage, url: compatUrl });

          data.files = files;
          data.path = compatUrl;
          data.sha512 = appImage.sha512;

          fs.writeFileSync(ymlPath, yaml.dump(data));
          console.log('Updated latest-linux.yml with compat AppImage entry (last)');
          NODE

          # Upload updated latest-linux.yml to release
          REPO="${GITHUB_REPOSITORY}"
          RELEASE_TAG=$(curl -fsSL \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/releases" \
            | node -e "let s='';process.stdin.on('data',d=>s+=d);process.stdin.on('end',()=>{const r=JSON.parse(s).find(x=>x.draft); if(!r){process.exit(1)}; console.log(r.tag_name)})")

          if [ -z "$RELEASE_TAG" ]; then
            echo "Could not find draft release tag" >&2
            exit 1
          fi

          gh release upload "$RELEASE_TAG" apps/electron/dist/latest-linux.yml --clobber

  release-linux-arm64:
    name: Release Linux ARM64 packages
    runs-on: ubuntu-22.04-arm
    env:
      TAR_OPTIONS: "--format=ustar"
      GH_TOKEN: ${{ secrets.GH_TOKEN }}

    steps:
      - uses: "actions/checkout@v4"

      - uses: "actions/setup-node@v4"
        with:
          node-version: '22.17.0'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libarchive-tools \
            rpm \
            libgtk-3-0 \
            libnss3 \
            libxss1 \
            libasound2 \
            libgbm1 \
            libx11-xcb1 \
            libdrm2 \
            libxkbcommon0 \
            libxrandr2 \
            libxcomposite1 \
            libxcursor1 \
            libxdamage1 \
            libxi6 \
            libxtst6 \
            xdg-utils

      - name: Install FPM
        run: |
          sudo apt-get update
          sudo apt-get install ruby ruby-dev build-essential
          sudo gem install --no-document fpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm turbo run build --filter=@aider-desk/common --filter=@aider-desk/core --filter=@aider-desk/ui --filter=@aider-desk/mcp-server

      - name: Build and Release Linux ARM64
        working-directory: apps/electron
        env:
          USE_SYSTEM_FPM: true
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: pnpm run build && pnpm exec electron-builder --linux --arm64 -p always

  release-win:
    name: Release Windows packages
    runs-on: windows-latest

    steps:
      - uses: "actions/checkout@v4"

      - uses: "actions/setup-node@v4"
        with:
          node-version: '22.17.0'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm turbo run build --filter=@aider-desk/common --filter=@aider-desk/core --filter=@aider-desk/ui --filter=@aider-desk/mcp-server

      - name: Build and Release Windows
        working-directory: apps/electron
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: pnpm run build && pnpm exec electron-builder --win -p always

  release-macos-x64:
    name: Release macOS x64 packages
    runs-on: macos-latest

    steps:
      - uses: "actions/checkout@v4"

      - uses: "actions/setup-node@v4"
        with:
          node-version: '22.17.0'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm turbo run build --filter=@aider-desk/common --filter=@aider-desk/core --filter=@aider-desk/ui --filter=@aider-desk/mcp-server

      - name: Create certificate.p12
        run: echo "$encoded_p12" | base64 --decode > certificate.p12
        env:
          encoded_p12: ${{ secrets.CSC_BASE64 }}

      - name: Build and Release macOS x64
        working-directory: apps/electron
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          CSC_LINK: "../../certificate.p12"
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          NODE_OPTIONS: --max-old-space-size=4096

        run: pnpm run build && pnpm exec electron-builder --mac --x64 -p always

      - name: Upload latest-mac.yml artifact
        uses: actions/upload-artifact@v4
        with:
          name: latest-mac-x64-yml
          path: apps/electron/dist/latest-mac.yml

  release-macos-arm64:
    name: Release macOS arm64 packages
    runs-on: macos-14

    steps:
      - uses: "actions/checkout@v4"

      - uses: "actions/setup-node@v4"
        with:
          node-version: '22.17.0'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm turbo run build --filter=@aider-desk/common --filter=@aider-desk/core --filter=@aider-desk/ui --filter=@aider-desk/mcp-server

      - name: Create certificate.p12
        run: echo "$encoded_p12" | base64 --decode > certificate.p12
        env:
          encoded_p12: ${{ secrets.CSC_BASE64 }}

      - name: Build and Release macOS arm64
        working-directory: apps/electron
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          CSC_LINK: "../../certificate.p12"
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          NODE_OPTIONS: --max-old-space-size=4096

        run: pnpm run build && pnpm exec electron-builder --mac --arm64 -p always

      - name: Upload latest-mac.yml artifact
        uses: actions/upload-artifact@v4
        with:
          name: latest-mac-arm64-yml
          path: apps/electron/dist/latest-mac.yml

  release-docker:
    name: Release Docker image
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}

    steps:
      - name: Clear up space
        run: sudo rm -rf /usr/local/.ghcup /usr/local/lib/android /usr/share/dotnet /usr/share/swift

      - uses: "actions/checkout@v4"

      - name: Get version from package.json
        id: get-version
        run: |
          # Get version from package.json
          VERSION=$(node -e "console.log(require('./package.json').version)")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using version: $VERSION"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build and push multi-platform Docker images
        run: |
          IMAGE_NAME=ghcr.io/${{ github.repository }}
          VERSION=${{ steps.get-version.outputs.version }}

          docker buildx build --platform linux/amd64,linux/arm64 \
            -f apps/node-server/Dockerfile \
            -t ${IMAGE_NAME}:${VERSION} \
            --push \
            .

          echo "Built and pushed multi-platform image: ${IMAGE_NAME}:${VERSION}"

  combine-macos-yml:
    name: Combine macOS yml files
    runs-on: ubuntu-latest
    needs: [release-macos-x64, release-macos-arm64]

    steps:
      - uses: "actions/checkout@v4"

      - uses: "actions/setup-node@v4"
        with:
          node-version: '22.17.0'

      - name: Download x64 yml artifact
        uses: actions/download-artifact@v4
        with:
          name: latest-mac-x64-yml
          path: artifacts/x64/

      - name: Download arm64 yml artifact
        uses: actions/download-artifact@v4
        with:
          name: latest-mac-arm64-yml
          path: artifacts/arm64/

      - name: Combine yml files
        run: |
          cat > combine-yml.js << 'EOF'
          const fs = require('fs');
          const yaml = require('js-yaml');

          // Read both yml files
          const x64Content = fs.readFileSync('artifacts/x64/latest-mac.yml', 'utf8');
          const arm64Content = fs.readFileSync('artifacts/arm64/latest-mac.yml', 'utf8');

          // Parse yml content
          const x64Data = yaml.load(x64Content);
          const arm64Data = yaml.load(arm64Content);

          // Combine files arrays
          const combinedData = {
            ...arm64Data,
            files: [...x64Data.files, ...arm64Data.files]
          };

          // Write combined yml
          fs.writeFileSync('latest-mac.yml', yaml.dump(combinedData));
          console.log('Combined yml file created successfully');
          EOF

          npm install js-yaml
          node combine-yml.js

      - name: Find draft release tag
        id: find-release
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Get the draft release tag
          RELEASE_TAG=$(gh release list --limit 1 --json tagName,isDraft --jq '.[] | select(.isDraft == true) | .tagName')
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT

      - name: Upload combined yml to release
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Upload the combined latest-mac.yml to the GitHub release
          gh release upload ${{ steps.find-release.outputs.release_tag }} latest-mac.yml --clobber
